minimum_cumulusci_version: "3.74.0"
project:
  name: Short-Cycle-Work
  package:
    name: Short-Cycle-Work
    api_version: "55.0"
  git:
    default_branch: "main"
    prefix_feature: "feature/"
    prefix_beta: "beta/"
    prefix_release: "release/"
  source_format: sfdx

tasks:
  install_managed:
    options:
      security_type: NONE

  update_dependencies:
    options:
      security_type: NONE

  robot:
    options:
      suites: robot/Short-Cycle-Work/tests
      options:
        outputdir: robot/Short-Cycle-Work/results

  robot_testdoc:
    options:
      path: robot/Short-Cycle-Work/tests
      output: robot/Short-Cycle-Work/doc/Short-Cycle-Work_tests.html

  run_tests:
    options:
      required_org_code_coverage_percent: 75

flows:
  deploy_qbrix:
    steps:
      1:
        flow: dependencies
      2:
        flow: deploy_qbrix_min
      3:
        flow: post_qbrix_deploy

  deploy_qbrix_min:
    steps:
      1:
        task: deploy
        options:
          path: force-app
        ui_options:
          name: Deploy Solution
      2:
        task: load_sample_data
        ui_options:
          name: Load Sample Data
          required: False
          recommended: True

  dependencies:
    steps:
      1:
        flow: prepare_org
      2:
        flow: source_dependencies

  source_dependencies:
    steps:
      1:
        flow: None

  post_qbrix_deploy:
    steps:
      1:
        flow: None

  prepare_org:
    steps:
      3:
        task: update_dependencies

  dev_org:
    steps:
      1:
        flow: None
      2:
        flow: deploy_qbrix
      3:
        flow: None

plans:
  install:
    slug: install
    tier: primary
    title: "Install Salesforce Field Service for E&U: Short Cycle Work"
    checks:
      - when: "'FSL' not in org_config.installed_packages or 'vlocity_cmt' not in org_config.installed_packages"
        action: error
        message: "This solution requires Field Service Lightning and Vlocity CMT. Please ensure these packages are installed before proceeding"
      - when: "'FieldServiceStandardPsl' not in tasks.get_assigned_permission_set_licenses() or 'vlocity_cmt.EAndUCloudBasePsl' not in tasks.get_assigned_permission_set_licenses()"
        action: error
        message: "This solution requires the Permission Set Licenses 'FieldServiceStandardPsl' and 'vlocity_cmt.EAndUCloudBasePsl'. Please ensure that you are assigned these Permission Set LIcenses before proceeding."
    steps:
      1:
        flow: deploy_qbrix
